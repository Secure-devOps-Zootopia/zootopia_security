name: Template Validation (Helm + K8s + Docker)

on:
  push:
    paths:
      - "k8s/**"
      - "helm/**"
      - "app/**"
      - ".github/workflows/template-validation.yml"
  pull_request:
    paths:
      - "k8s/**"
      - "helm/**"
      - "app/**"
  workflow_dispatch:

jobs:
  validate-templates:
    name: Validate Deployment Templates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ----------------------
      # Helm Validation
      # ----------------------
      - name: Install Helm
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Lint Helm chart
        run: helm lint helm/zootopia

      - name: Render Helm chart (template output preview)
        run: helm template test helm/zootopia
        
      # ----------------------
      # 3. KUBERNETES SECURITY VALIDATION
      # ----------------------
      - name: Install kube-score (K8s security scanner)
        run: |
          wget https://github.com/zegl/kube-score/releases/download/v1.17.0/kube-score_1.17.0_linux_amd64.tar.gz
          tar -xvzf kube-score_1.17.0_linux_amd64.tar.gz
          sudo mv kube-score /usr/local/bin/
      
      - name: Score K8s manifest security
        run: |
          echo "=== KUBE-SCORE SECURITY ANALYSIS ==="
          kube-score score k8s/deployment.yaml --output-format ci || true
          
          echo ""
          echo "=== CRITICAL SECURITY CHECKS ==="
          kube-score score k8s/deployment.yaml --output-format ci --ignore-test container-image-tag,container-resources || true
          
          echo "âœ… K8s security analysis complete"

      # ----------------------
      # Dockerfile validation (build only)
      # ----------------------
      - name: Build Docker image (validation only)
        run: docker build -t zootopia-template-check ./app
