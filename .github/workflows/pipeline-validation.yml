name: Template Validation (Helm + K8s + Docker)

on:
  push:
    paths:
      - "k8s/**"
      - "helm/**"
      - "app/**"
      - ".github/workflows/template-validation.yml"
  pull_request:
    paths:
      - "k8s/**"
      - "helm/**"
      - "app/**"
  workflow_dispatch:

jobs:
  validate-templates:
    name: Validate Deployment Templates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ----------------------
      # Helm Validation
      # ----------------------
      - name: Install Helm
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Lint Helm chart
        run: helm lint helm/zootopia

      - name: Render Helm chart (template output preview)
        run: helm template test helm/zootopia
        
      # ----------------------
      # 3. KUBERNETES MANIFEST VALIDATION
      # ----------------------
      - name: Install kubectl (for manifest validation)
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
      
      - name: Dry-run apply K8s manifest
        run: |
          echo "Testing Kubernetes manifest with kubectl --dry-run"
          kubectl apply -f k8s/deployment.yaml --dry-run=client
          echo "âœ… K8s manifest syntax is valid"

      # ----------------------
      # Dockerfile validation (build only)
      # ----------------------
      - name: Build Docker image (validation only)
        run: docker build -t zootopia-template-check ./app
