name: CD Pipeline

on:
  push:
    branches:
      - main
    paths:
      - "Dockerfile"
      - "src/**"
      #- ".github/workflows/**"

jobs:
  cd:
    name: Build, Deploy & Security Testing
    runs-on: ubuntu-latest

    env:
      ELK_URL: ${{ secrets.ELK_URL }}
      ELK_API_KEY: ${{ secrets.ELK_API_KEY }}
      STAGING_URL: ${{ secrets.STAGING_URL }}
      AWS_REGION: us-east-1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------
      # Build deployment image
      # ----------------------
      - name: Build Docker image for staging
        run: docker build -t spring-backend:staging .

      - name: Login to Docker registry
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push Docker image to registry
        run:
          docker tag spring-backend:staging your-registry/spring-backend:staging && \
          docker push your-registry/spring-backend:staging

      # ----------------------
      # Deploy to staging
      # ----------------------
      - name: Deploy to staging
        run: ./scripts/deploy-staging.sh

      # ----------------------
      # DAST scan
      # ----------------------
      - name: DAST scan against staging
        uses: zaproxy/action-full-scan@v0.7.0
        with:
          target: ${{ env.STAGING_URL }}
          format: "json"
          output: dast-report.json

      # ----------------------
      # Optional Cloud Posture Scan
      # ----------------------
      - name: Run AWS Security Posture Scan
        run: |
          echo "Running cloud posture scan"
          # Example: Prowler or Security Hub
          # prowler -M json > prowler-report.json

      # ----------------------
      # Push artifacts to ELK / Upload
      # ----------------------
      - name: Push Security Artifacts to ELK/Audit Log
        run: |
          for file in dast-report.json prowler-report.json; do
            if [ -f "$file" ]; then
              echo "Pushing $file to ELK"
              curl -X POST "$ELK_URL/_bulk" \
                -H "Authorization: Bearer $ELK_API_KEY" \
                -H 'Content-Type: application/json' \
                --data-binary @"$file"
            else
              echo "$file not found, skipping"
            fi
          done

      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: cd-security-reports
          path: |
            dast-report.json
            prowler-report.json
