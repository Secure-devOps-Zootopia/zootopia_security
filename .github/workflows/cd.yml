name: CD Pipeline (Post-Merge Deployment & Runtime Security)

on:
  pull_request:
    branches:
      - main
    types:
      - closed   # We only care about merge events

jobs:
  cd:
    name: Deploy, DAST & Cloud Security
    runs-on: ubuntu-latest

    # Run ONLY if PR was merged
    if: github.event.pull_request.merged == true

    env:
      ELK_URL: ${{ secrets.ELK_URL }}
      ELK_API_KEY: ${{ secrets.ELK_API_KEY }}
      STAGING_URL: ${{ secrets.STAGING_URL }}
      AWS_REGION: us-east-1

    steps:
      # ----------------------
      # Checkout merged code
      # ----------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------
      # Build deployment image
      # ----------------------
      - name: Build Docker image for staging
        run: docker build -t spring-backend:staging .

      - name: Login to Docker registry
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push Docker image to registry
        run: |
          docker tag spring-backend:staging your-registry/spring-backend:staging
          docker push your-registry/spring-backend:staging

      # ----------------------
      # Configure Kubernetes access
      # ----------------------
      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" > $HOME/.kube/config

      # ----------------------
      # Deploy to Kubernetes
      # ----------------------
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: '1.27.0'
      - name: Apply Kubernetes deployment
        run: |
          kubectl apply -f k8s/deployment.yaml

      # # ----------------------
      # # Deploy to staging
      # # ----------------------
      # - name: Deploy to staging
      #   run: ./scripts/deploy-staging.sh

      # # ----------------------
      # # DAST (Runtime App Security)
      # # ----------------------
      # - name: DAST scan against staging
      #   uses: zaproxy/action-full-scan@v0.7.0
      #   with:
      #     target: ${{ env.STAGING_URL }}
      #     format: json
      #     output: dast-report.json

      # ----------------------
      # Cloud Security Posture (AWS)
      # ----------------------
      - name: Run AWS Security Posture Scan (Prowler)
        run: |
          pip install prowler
          prowler aws \
            --severity high,critical \
            --output-formats json \
            --output-directory prowler-output

      # ----------------------
      # Push artifacts to ELK / Audit
      # ----------------------
      # - name: Push Security Artifacts to ELK/Audit Log
      #   run: |
      #     for file in dast-report.json prowler-output/*.json; do
      #       if [ -f "$file" ]; then
      #         echo "Pushing $file to ELK"
      #         curl -X POST "$ELK_URL/_bulk" \
      #           -H "Authorization: Bearer $ELK_API_KEY" \
      #           -H 'Content-Type: application/json' \
      #           --data-binary @"$file"
      #       else
      #         echo "$file not found, skipping"
      #       fi
      #     done

      # ----------------------
      # Upload reports
      # ----------------------
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: cd-security-reports
          path: |
            dast-report.json
            prowler-output
