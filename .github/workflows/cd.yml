name: CD Pipeline (Post-Merge Deployment & Runtime Security)

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    types:
      - closed   # We only care about merge events

jobs:
  cd:
    name: Deploy, DAST & Cloud Security
    runs-on: ubuntu-latest

    # Run ONLY if PR was merged
    if: github.event.pull_request.merged == true

    env:
      ELK_URL: ${{ secrets.ELK_URL }}
      ELK_API_KEY: ${{ secrets.ELK_API_KEY }}
      STAGING_URL: ${{ secrets.STAGING_URL }}
      AWS_REGION: us-east-1

    steps:
      # ----------------------
      # Checkout merged code
      # ----------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # # ----------------------
      # # Build deployment image
      # # ----------------------
      - name: Pull Docker image
        run: docker pull hlahany/zootopia-petshop:latest

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: hlahany/zootopia-petshop:latest
          format: table
          severity: CRITICAL

      
      # # ----------------------
      # # Configure Kubernetes access
      # # ----------------------
      # - name: Configure kubeconfig
      #   run: |
      #     mkdir -p $HOME/.kube
      #     echo "${{ secrets.KUBE_CONFIG }}" > $HOME/.kube/config

      # # ----------------------
      # Deploy to Kubernetes
      # ----------------------
      # - name: Set up kubectl
      #   continue-on-error: true
      #   uses: azure/setup-kubectl@v3
    
      # - name: Install kind manually
      #   continue-on-error: true
      #   run: |
      #     curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
      #     chmod +x ./kind
      #     sudo mv ./kind /usr/local/bin/kind

      # - name: Create kind cluster
      #   continue-on-error: true
      #   run: kind create cluster --wait 60s

      # - name: Verify cluster
      #   continue-on-error: true
      #   run: kubectl cluster-info


      # - name: Apply Kubernetes deployment
      #   continue-on-error: true
      #   run: |
      #     kubectl apply -f k8s/deployment.yaml



      # # ----------------------
      # # DAST (Runtime App Security)
      # # ----------------------      
      - name: Run DAST scan (OWASP ZAP)
        continue-on-error: true
        uses: zaproxy/action-full-scan@v0.7.0
        with:
          target: ${{ env.STAGING_URL }}
          fail_action: false
          allow_issue_writing: false
      
      - name: Upload DAST report
        continue-on-error: true
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dast-report
          path: |
            report_html.html
            report_json.json
            report_md.md


      # ----------------------
      # Security Headers Check
      # ----------------------
      - name: Security Headers Scan
        continue-on-error: true
        run: |
          pip install observatory-cli
          observatory ${{ env.STAGING_URL }} --format=report --zero --rescan > security-headers-report.txt 2>&1 || true
          curl -I ${{ env.STAGING_URL }} >> security-headers-report.txt 2>&1 || true

      # ----------------------
      # SSL/TLS Security Check
      # ----------------------
      - name: SSL/TLS Scan
        continue-on-error: true
        run: |
          git clone --depth 1 https://github.com/drwetter/testssl.sh.git
          cd testssl.sh
          ./testssl.sh --severity HIGH --jsonfile-pretty ../ssl-report.json zootopia-security.onrender.com || true
          ./testssl.sh --severity HIGH zootopia-security.onrender.com > ../ssl-report.txt 2>&1 || true

      # ----------------------
      # Container Security Scan (Docker Scout)
      # ----------------------
      - name: Docker Scout CVE Scan
        continue-on-error: true
        run: |
          curl -sSfL https://raw.githubusercontent.com/docker/scout-cli/main/install.sh | sh -s --
          docker scout cves hlahany/zootopia-petshop:latest --format sarif --output scout-report.sarif 2>&1 || true
          docker scout cves hlahany/zootopia-petshop:latest > scout-report.txt 2>&1 || true

      # ----------------------
      # Push artifacts to ELK / Audit
      # ----------------------
      # - name: Push Security Artifacts to ELK/Audit Log
      #   run: |
      #     for file in dast-report.json prowler-output/*.json; do
      #       if [ -f "$file" ]; then
      #         echo "Pushing $file to ELK"
      #         curl -X POST "$ELK_URL/_bulk" \
      #           -H "Authorization: Bearer $ELK_API_KEY" \
      #           -H 'Content-Type: application/json' \
      #           --data-binary @"$file"
      #       else
      #         echo "$file not found, skipping"
      #       fi
      #     done

      # ----------------------
      # Upload reports
      # ----------------------
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cd-security-reports
          path: |
            security-headers-report.txt
            ssl-report.txt
            ssl-report.json
            scout-report.txt
            scout-report.sarif




